name: Deploy to Render

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: "Service to deploy"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - backend
          - frontend

jobs:
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    if: |
      (github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch') &&
      (github.event.inputs.service == 'all' || github.event.inputs.service == 'backend' || github.event.inputs.service == null)

    steps:
      - name: Trigger Render Deploy Hook (Backend)
        run: |
          if [ -z "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK }}" ]; then
            echo "RENDER_BACKEND_DEPLOY_HOOK secret is not set"
            echo "Skipping backend deployment..."
            echo "To enable: Add your Render deploy hook URL as a GitHub secret"
            exit 0
          fi

          echo "Triggering backend deployment on Render..."

          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK }}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "Backend deployment triggered successfully!"
            echo "Response: $body"
          else
            echo "Failed to trigger backend deployment"
            echo "HTTP Status: $http_code"
            echo "Response: $body"
            exit 1
          fi

  deploy-frontend:
    name: Deploy Frontend to Render
    runs-on: ubuntu-latest
    if: |
      (github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch') &&
      (github.event.inputs.service == 'all' || github.event.inputs.service == 'frontend' || github.event.inputs.service == null)

    steps:
      - name: Trigger Render Deploy Hook (Frontend)
        run: |
          if [ -z "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}" ]; then
            echo "RENDER_FRONTEND_DEPLOY_HOOK secret is not set"
            echo "Skipping frontend deployment..."
            echo "To enable: Add your Render deploy hook URL as a GitHub secret"
            exit 0
          fi

          echo "Triggering frontend deployment on Render..."

          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "Frontend deployment triggered successfully!"
            echo "Response: $body"
          else
            echo "Failed to trigger frontend deployment"
            echo "HTTP Status: $http_code"
            echo "Response: $body"
            exit 1
          fi

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')

    steps:
      - name: Wait for Render deployment
        run: |
          echo "Waiting 60 seconds for Render to deploy..."
          sleep 60

      - name: Check Backend Health
        if: ${{ secrets.RENDER_BACKEND_URL != '' }}
        run: |
          BACKEND_URL="${{ secrets.RENDER_BACKEND_URL }}"

          if [ -z "$BACKEND_URL" ]; then
            echo "RENDER_BACKEND_URL not set, skipping health check"
            exit 0
          fi

          echo "üîç Checking backend health at $BACKEND_URL/api/health..."

          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/health" || echo "000")
            
            if [ "$response" -eq 200 ]; then
              echo "Backend is healthy!"
              exit 0
            fi
            
            echo "Attempt $i: Got HTTP $response, retrying in 15 seconds..."
            sleep 15
          done

          echo "Backend health check inconclusive (may still be deploying)"

      - name: Check Frontend Health
        if: ${{ secrets.RENDER_FRONTEND_URL != '' }}
        run: |
          FRONTEND_URL="${{ secrets.RENDER_FRONTEND_URL }}"

          if [ -z "$FRONTEND_URL" ]; then
            echo "RENDER_FRONTEND_URL not set, skipping health check"
            exit 0
          fi

          echo "Checking frontend at $FRONTEND_URL..."

          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
            
            if [ "$response" -eq 200 ]; then
              echo "Frontend is healthy!"
              exit 0
            fi
            
            echo "Attempt $i: Got HTTP $response, retrying in 15 seconds..."
            sleep 15
          done

          echo "Frontend health check inconclusive (may still be deploying)"

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
          echo ""
          echo "Check your Render dashboard for deployment status:"
          echo "   https://dashboard.render.com"
          echo "=========================================="
